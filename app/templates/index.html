<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KagentaMail</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/framer-motion/10.16.4/framer-motion.min.js"></script>
    <style>
        :root {
            /* Apple System Font Stack */
            --font-stack: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            --bg-body: #000000;
            --bg-card: #1c1c1e;
            --bg-card-hover: #2c2c2e;
            --accent: #0A84FF; /* iOS Blue */
            --danger: #FF453A; /* iOS Red */
            --text-primary: #FFFFFF;
            --text-secondary: #8E8E93;
            --separator: #38383A;
        }
        body {
            font-family: var(--font-stack);
            background-color: var(--bg-body);
            color: var(--text-primary);
            -webkit-font-smoothing: antialiased;
            overflow: hidden; /* App feel */
        }
        
        /* Grid Layout (Bento) */
        .bento-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            gap: 1px;
            background-color: var(--separator);
        }
        
        @media (max-width: 768px) {
            .bento-grid {
                grid-template-columns: 1fr;
                grid-template-rows: 60px auto 1fr;
            }
        }

        .cell {
            background-color: var(--bg-body);
            overflow: hidden;
        }

        /* Apple-style Blur */
        .glass-header {
            background: rgba(28, 28, 30, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        /* iOS Input Field */
        .ios-input {
            background: #1c1c1e;
            border-radius: 12px;
            font-size: 17px;
            transition: all 0.2s ease;
        }
        .ios-input:focus-within {
            background: #2c2c2e;
        }

        /* iOS Buttons */
        .ios-btn {
            border-radius: 12px;
            font-weight: 600;
            font-size: 15px;
            transition: transform 0.1s, opacity 0.2s;
        }
        .ios-btn:active {
            transform: scale(0.96);
            opacity: 0.8;
        }

        /* List Items */
        .mail-item {
            border-bottom: 1px solid var(--separator);
            transition: background 0.2s;
        }
        .mail-item:last-child { border-bottom: none; }
        .mail-item:hover, .mail-item.active {
            background-color: var(--bg-card-hover);
        }

        /* Scrollbar Hide */
        ::-webkit-scrollbar { display: none; }
        
        /* Loading Shimmer */
        .shimmer {
            background: linear-gradient(90deg, #1c1c1e 25%, #2c2c2e 50%, #1c1c1e 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        
        /* Particle Explosion for Destroy */
        .particle {
            position: absolute;
            pointer-events: none;
            animation: explode 0.6s ease-out forwards;
        }
        @keyframes explode {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }
    </style>
</head>
<body>

    <div class="bento-grid">
        
        <!-- 1. HEADER (Top Full Width) -->
        <header class="cell col-span-full flex items-center justify-between px-6 glass-header border-b border-[#38383A]">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-white rounded-lg flex items-center justify-center shadow-lg">
                    <i data-lucide="mail" class="text-black w-5 h-5"></i>
                </div>
                <span class="font-bold text-xl tracking-tight">Kagenta</span>
            </div>
            <div class="flex items-center gap-3">
                <span class="text-[11px] font-medium text-[#8E8E93] bg-[#1c1c1e] px-2 py-1 rounded-md">SECURE SESSION</span>
                <div class="w-2 h-2 rounded-full bg-[#30D158] shadow-[0_0_8px_#30D158]"></div>
            </div>
        </header>

        <!-- 2. SIDEBAR / CONTROL PANEL -->
        <aside class="cell p-6 flex flex-col gap-6 bg-[#000000]">
            
            <!-- Email Display -->
            <div class="space-y-2">
                <label class="text-xs font-semibold text-[#8E8E93] uppercase tracking-wider ml-1">Temporary Address</label>
                <div class="ios-input h-14 flex items-center px-4 relative group cursor-pointer" onclick="copyEmail()">
                    <input type="text" id="emailDisplay" readonly value="Initializing..." 
                        class="bg-transparent w-full text-white outline-none font-mono text-[15px] truncate pr-8 cursor-pointer">
                    <i data-lucide="copy" class="w-5 h-5 text-[#8E8E93] absolute right-4 group-hover:text-white transition-colors"></i>
                    
                    <!-- Toast -->
                    <div id="toast" class="absolute top-[-40px] left-1/2 -translate-x-1/2 bg-white text-black text-xs font-bold px-3 py-1.5 rounded-full shadow-xl opacity-0 transition-all duration-300 transform translate-y-2 pointer-events-none">
                        COPIED
                    </div>
                </div>
            </div>

            <!-- Main Actions -->
            <div class="grid grid-cols-2 gap-3">
                <button onclick="generateEmail()" class="ios-btn h-12 bg-[#1c1c1e] text-white flex items-center justify-center gap-2 hover:bg-[#2c2c2e]">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i> New
                </button>
                <button onclick="destroySession()" class="ios-btn h-12 bg-[#FF453A]/10 text-[#FF453A] flex items-center justify-center gap-2 hover:bg-[#FF453A]/20 relative overflow-hidden" id="btnDestroy">
                    <i data-lucide="flame" class="w-4 h-4"></i> Burn
                </button>
            </div>

            <!-- Stats / Info -->
            <div class="mt-auto bg-[#1c1c1e] rounded-xl p-4 flex items-center justify-between">
                <div class="flex flex-col">
                    <span class="text-xs text-[#8E8E93]">Inbox Status</span>
                    <span class="text-sm font-medium text-white flex items-center gap-2">
                        <span class="w-1.5 h-1.5 rounded-full bg-[#0A84FF] animate-pulse"></span>
                        Live Sync
                    </span>
                </div>
                <div class="text-right">
                    <span class="text-xs text-[#8E8E93]">Next Update</span>
                    <div class="text-sm font-mono text-white" id="timer">05</div>
                </div>
            </div>
        </aside>

        <!-- 3. INBOX AREA -->
        <main class="cell flex flex-col bg-[#000000] relative">
            <div class="h-12 border-b border-[#38383A] flex items-center px-6 justify-between bg-[#000000]/80 backdrop-blur sticky top-0 z-40">
                <h2 class="text-sm font-semibold text-white">Messages</h2>
                <button onclick="refreshInbox()" class="p-2 -mr-2 text-[#8E8E93] hover:text-white transition-colors">
                    <i data-lucide="rotate-cw" class="w-4 h-4"></i>
                </button>
            </div>

            <!-- Inbox List -->
            <div id="inboxList" class="flex-1 overflow-y-auto pb-20">
                <!-- Empty State -->
                <div class="h-full flex flex-col items-center justify-center text-[#2c2c2e] gap-4">
                    <div class="w-20 h-20 rounded-full bg-[#1c1c1e] flex items-center justify-center">
                        <i data-lucide="inbox" class="w-8 h-8 opacity-50"></i>
                    </div>
                    <p class="text-sm font-medium">No messages yet</p>
                </div>
            </div>
        </main>

    </div>

    <!-- MODAL (Detail View) -->
    <div id="detailModal" class="fixed inset-0 z-[100] bg-black/60 backdrop-blur-xl hidden opacity-0 transition-opacity duration-300">
        <div class="absolute inset-x-0 bottom-0 md:inset-auto md:top-1/2 md:left-1/2 md:-translate-x-1/2 md:-translate-y-1/2 w-full md:w-[600px] h-[85vh] md:h-[600px] bg-[#1c1c1e] md:rounded-2xl rounded-t-2xl shadow-2xl flex flex-col transform transition-transform duration-300 translate-y-full md:translate-y-10 scale-95" id="modalPanel">
            
            <!-- Drag Handle (Mobile) -->
            <div class="h-1.5 w-12 bg-[#38383A] rounded-full mx-auto mt-3 md:hidden"></div>

            <!-- Header -->
            <div class="p-5 border-b border-[#38383A] flex justify-between items-start">
                <div class="flex-1 pr-4">
                    <h1 id="mSubject" class="text-lg font-bold text-white leading-tight mb-1">Subject</h1>
                    <div class="flex items-center gap-2 text-sm text-[#8E8E93]">
                        <i data-lucide="user-circle" class="w-4 h-4"></i>
                        <span id="mFrom" class="truncate">sender@example.com</span>
                    </div>
                </div>
                <button onclick="closeModal()" class="w-8 h-8 bg-[#2c2c2e] rounded-full flex items-center justify-center text-[#8E8E93] hover:text-white hover:bg-[#3a3a3c] transition-colors">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            </div>

            <!-- Body -->
            <div class="flex-1 overflow-y-auto p-5 bg-[#000000]">
                <div id="mBody" class="prose prose-invert prose-sm max-w-none text-[#D1D1D6]"></div>
                
                <!-- Attachments Section -->
                <div id="mAttachments" class="mt-8 pt-4 border-t border-[#38383A] hidden">
                    <h4 class="text-xs font-bold text-[#8E8E93] uppercase mb-3">Attachments</h4>
                    <div class="grid grid-cols-2 gap-3" id="attachList"></div>
                </div>
            </div>

            <!-- Toolbar -->
            <div class="p-4 border-t border-[#38383A] bg-[#1c1c1e] flex justify-between items-center text-xs text-[#8E8E93]">
                <span id="mDate">Today, 12:00 PM</span>
                <button class="text-[#0A84FF] font-medium hover:underline">Download EML</button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // --- STATE ---
        const STATE = {
            email: localStorage.getItem('kg_email') || '',
            messages: [],
            hash: '',
            timer: 5
        };

        // --- CORE FUNCTIONS ---

        async function generateEmail() {
            const el = document.getElementById('emailDisplay');
            el.value = "Creating ID...";
            
            try {
                // Using v2 engine
                const res = await fetch('/api/create?version=v2');
                const data = await res.json();
                const email = data.result?.email || data.email;

                if (email) {
                    STATE.email = email;
                    localStorage.setItem('kg_email', email);
                    el.value = email;
                    // Reset UI
                    STATE.messages = [];
                    STATE.hash = '';
                    renderInbox();
                    refreshInbox();
                }
            } catch (e) {
                el.value = "Connection Failed";
            }
        }

        async function refreshInbox() {
            if (!STATE.email) return;
            
            const icon = document.querySelector('button[onclick="refreshInbox()"] i');
            icon.classList.add('animate-spin');

            try {
                const res = await fetch(`/api/inbox?email=${STATE.email}&version=v2`);
                const data = await res.json();
                const mails = Array.isArray(data.result) ? data.result : [];

                // Simple content hash check
                const newHash = JSON.stringify(mails.map(m => m.id || m.date));
                if (newHash !== STATE.hash) {
                    STATE.messages = mails;
                    STATE.hash = newHash;
                    renderInbox();
                }
            } catch (e) {
                console.error(e);
            } finally {
                setTimeout(() => icon.classList.remove('animate-spin'), 500);
            }
        }

        function renderInbox() {
            const container = document.getElementById('inboxList');
            
            if (STATE.messages.length === 0) {
                container.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center text-[#2c2c2e] gap-4">
                        <div class="w-20 h-20 rounded-full bg-[#1c1c1e] flex items-center justify-center">
                            <i data-lucide="inbox" class="w-8 h-8 opacity-50"></i>
                        </div>
                        <p class="text-sm font-medium">No messages yet</p>
                    </div>`;
                lucide.createIcons();
                return;
            }

            let html = "";
            STATE.messages.forEach((msg, idx) => {
                // Check for attachments (Nekolabs usually puts them in 'attachments' array)
                const hasAttach = msg.attachments && msg.attachments.length > 0;
                
                html += `
                    <div onclick="openModal(${idx})" class="mail-item p-4 cursor-pointer group">
                        <div class="flex justify-between items-baseline mb-1">
                            <h3 class="font-semibold text-[15px] text-white group-hover:text-[#0A84FF] transition-colors truncate pr-4">${msg.from}</h3>
                            <span class="text-[11px] text-[#8E8E93] font-medium whitespace-nowrap">${msg.date || 'Now'}</span>
                        </div>
                        <p class="text-[14px] text-[#D1D1D6] font-medium truncate mb-1">${msg.subject || '(No Subject)'}</p>
                        <p class="text-[13px] text-[#8E8E93] truncate">${msg.text ? msg.text.substring(0, 60) : 'HTML Content'}...</p>
                        
                        ${hasAttach ? `
                        <div class="mt-2 inline-flex items-center gap-1 bg-[#1c1c1e] px-2 py-1 rounded text-[10px] text-[#8E8E93]">
                            <i data-lucide="paperclip" class="w-3 h-3"></i> Attachment
                        </div>` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
            lucide.createIcons();
        }

        // --- FEATURES ---

        function destroySession() {
            const btn = document.getElementById('btnDestroy');
            
            // Particle Effect
            const rect = btn.getBoundingClientRect();
            for(let i=0; i<20; i++) {
                const p = document.createElement('div');
                p.classList.add('particle');
                p.style.backgroundColor = '#FF453A';
                p.style.width = Math.random() * 4 + 'px';
                p.style.height = p.style.width;
                p.style.left = (rect.left + rect.width/2) + 'px';
                p.style.top = (rect.top + rect.height/2) + 'px';
                p.style.setProperty('--tx', (Math.random() * 200 - 100) + 'px');
                p.style.setProperty('--ty', (Math.random() * 200 - 100) + 'px');
                document.body.appendChild(p);
                setTimeout(() => p.remove(), 600);
            }

            // Logic wipe
            STATE.email = '';
            STATE.messages = [];
            STATE.hash = '';
            localStorage.removeItem('kg_email');
            
            document.getElementById('emailDisplay').value = "Destroyed.";
            renderInbox();
            
            setTimeout(() => {
                generateEmail();
            }, 1000);
        }

        function copyEmail() {
            const el = document.getElementById('emailDisplay');
            if (!el.value || el.value.includes('...')) return;
            
            navigator.clipboard.writeText(el.value);
            const toast = document.getElementById('toast');
            toast.classList.remove('translate-y-2', 'opacity-0');
            setTimeout(() => {
                toast.classList.add('translate-y-2', 'opacity-0');
            }, 2000);
        }

        function openModal(idx) {
            const msg = STATE.messages[idx];
            if (!msg) return;

            document.getElementById('mSubject').innerText = msg.subject || '(No Subject)';
            document.getElementById('mFrom').innerText = msg.from;
            document.getElementById('mDate').innerText = msg.date || 'Today';
            
            const bodyDiv = document.getElementById('mBody');
            if (msg.html) bodyDiv.innerHTML = msg.html;
            else bodyDiv.innerText = msg.text || '';

            // Handle Attachments
            const attachSection = document.getElementById('mAttachments');
            const attachList = document.getElementById('attachList');
            
            if (msg.attachments && msg.attachments.length > 0) {
                attachSection.classList.remove('hidden');
                let attachHtml = "";
                msg.attachments.forEach(file => {
                    attachHtml += `
                        <a href="${file.url}" target="_blank" class="flex items-center gap-3 p-3 bg-[#1c1c1e] rounded-lg border border-[#38383A] hover:bg-[#2c2c2e] transition-colors">
                            <div class="w-8 h-8 bg-[#38383A] rounded flex items-center justify-center">
                                <i data-lucide="file" class="w-4 h-4 text-white"></i>
                            </div>
                            <div class="overflow-hidden">
                                <p class="text-xs font-medium text-white truncate w-32">${file.filename}</p>
                                <p class="text-[10px] text-[#8E8E93]">${file.size || 'Unknown'}</p>
                            </div>
                        </a>
                    `;
                });
                attachList.innerHTML = attachHtml;
                lucide.createIcons();
            } else {
                attachSection.classList.add('hidden');
            }

            const modal = document.getElementById('detailModal');
            const panel = document.getElementById('modalPanel');
            
            modal.classList.remove('hidden');
            // Force reflow
            void modal.offsetWidth;
            
            modal.classList.remove('opacity-0');
            panel.classList.remove('translate-y-full', 'scale-95');
            panel.classList.add('md:translate-y-0', 'translate-y-0', 'scale-100');
        }

        function closeModal() {
            const modal = document.getElementById('detailModal');
            const panel = document.getElementById('modalPanel');
            
            modal.classList.add('opacity-0');
            panel.classList.add('translate-y-full', 'scale-95');
            panel.classList.remove('md:translate-y-0', 'translate-y-0', 'scale-100');
            
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        // Loop
        setInterval(() => {
            STATE.timer--;
            if (STATE.timer <= 0) {
                refreshInbox();
                STATE.timer = 5;
            }
            document.getElementById('timer').innerText = STATE.timer.toString().padStart(2, '0');
        }, 1000);

        // Init
        if (STATE.email) {
            document.getElementById('emailDisplay').value = STATE.email;
            refreshInbox();
        } else {
            generateEmail();
        }

    </script>
</body>
</html>