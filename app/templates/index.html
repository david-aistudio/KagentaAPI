<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KagentaMail | Onyx</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/framer-motion/10.16.4/framer-motion.min.js"></script>
    <style>
        :root {
            --bg-body: #050505;
            --bg-card: #0F0F0F;
            --border-subtle: #1F1F1F;
            --accent-primary: #FFFFFF;
            --text-main: #EDEDED;
            --text-muted: #888888;
        }
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            -webkit-tap-highlight-color: transparent;
        }
        .glass-panel {
            background: rgba(15, 15, 15, 0.6);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255,255,255,0.05);
        }
        .btn-press {
            transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-press:active {
            transform: scale(0.96);
        }
        .shimmer {
            position: relative;
            overflow: hidden;
        }
        .shimmer::after {
            content: '';
            position: absolute;
            top: 0; right: 0; bottom: 0; left: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.03), transparent);
            transform: translateX(-100%);
            animation: shimmer 2s infinite;
        }
        @keyframes shimmer {
            100% { transform: translateX(100%); }
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- HEADER -->
    <header class="h-16 border-b border-[#1F1F1F] flex items-center justify-between px-6 bg-[#050505]/80 backdrop-blur-md z-50">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-white rounded-lg flex items-center justify-center">
                <i data-lucide="mail" class="text-black w-5 h-5"></i>
            </div>
            <span class="font-bold text-lg tracking-tight">Kagenta<span class="text-[#444]">Mail</span></span>
        </div>
        <div class="flex items-center gap-4">
            <span class="text-xs font-mono text-[#444] hidden md:block">v1.1.0-RAG</span>
            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col md:flex-row relative overflow-hidden">
        
        <!-- LEFT: CONTROLS -->
        <section class="w-full md:w-[400px] border-r border-[#1F1F1F] flex flex-col bg-[#080808]">
            <div class="p-6 space-y-6">
                <!-- Status Card -->
                <div class="glass-panel p-5 rounded-2xl relative overflow-hidden group">
                    <div class="absolute inset-0 bg-gradient-to-br from-purple-500/10 to-blue-500/10 opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                    <label class="text-[10px] uppercase tracking-widest text-[#666] font-semibold mb-2 block">Current Address</label>
                    
                    <div class="relative">
                        <input type="text" id="emailDisplay" readonly value="Generating..." 
                            class="w-full bg-transparent text-xl font-mono text-white outline-none placeholder-[#333] truncate pr-10"
                            onclick="copyEmail()">
                        <button onclick="copyEmail()" class="absolute right-0 top-1/2 -translate-y-1/2 text-[#444] hover:text-white transition-colors">
                            <i data-lucide="copy" class="w-5 h-5"></i>
                        </button>
                    </div>
                    
                    <div id="copyFeedback" class="absolute top-2 right-2 bg-white text-black text-[10px] px-2 py-1 rounded font-bold opacity-0 transition-opacity">COPIED</div>
                </div>

                <!-- Actions -->
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="generateEmail()" class="btn-press h-12 bg-white text-black font-semibold rounded-xl flex items-center justify-center gap-2 hover:bg-gray-200 transition-colors">
                        <i data-lucide="refresh-cw" class="w-4 h-4"></i> Generate
                    </button>
                    <button onclick="refreshInbox()" class="btn-press h-12 glass-panel text-white font-medium rounded-xl flex items-center justify-center gap-2 hover:bg-white/5 transition-colors">
                        <i data-lucide="inbox" class="w-4 h-4"></i> Refresh
                    </button>
                </div>

                <!-- Timer -->
                <div class="flex items-center justify-center gap-2 text-xs text-[#444] font-mono mt-4">
                    <i data-lucide="clock" class="w-3 h-3"></i>
                    <span>Auto-refresh in <span id="timer" class="text-white">5</span>s</span>
                </div>
            </div>

            <!-- Ad / Info Space -->
            <div class="mt-auto p-6 text-center">
                <p class="text-[10px] text-[#333] leading-relaxed">
                    Messages are deleted after 1 hour.<br>
                    Engine: Nekolabs v2 (High Speed)
                </p>
            </div>
        </section>

        <!-- RIGHT: INBOX -->
        <section class="flex-1 bg-[#050505] flex flex-col relative">
            <!-- Header Inbox -->
            <div class="h-14 border-b border-[#1F1F1F] flex items-center px-6 justify-between">
                <h2 class="font-medium text-sm text-[#888]">Inbox Messages</h2>
                <span id="msgCount" class="bg-[#1F1F1F] text-white text-[10px] px-2 py-1 rounded-full">0</span>
            </div>

            <!-- List -->
            <div id="inboxList" class="flex-1 overflow-y-auto p-4 space-y-3">
                <!-- Empty State -->
                <div class="h-full flex flex-col items-center justify-center text-[#222]">
                    <i data-lucide="ghost" class="w-16 h-16 mb-4 opacity-50"></i>
                    <p class="text-sm">Waiting for incoming mail...</p>
                </div>
            </div>
        </section>

    </main>

    <!-- EMAIL DETAIL MODAL -->
    <div id="mailModal" class="fixed inset-0 z-[100] bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div class="bg-[#0F0F0F] border border-[#222] w-full max-w-2xl h-[80vh] rounded-2xl flex flex-col shadow-2xl transform scale-95 transition-transform duration-300" id="modalContent">
            
            <!-- Modal Header -->
            <div class="h-16 border-b border-[#222] flex items-center justify-between px-6">
                <div class="flex flex-col">
                    <span id="modalSubject" class="font-bold text-white truncate max-w-md">Subject</span>
                    <span id="modalFrom" class="text-xs text-[#666] truncate">from@example.com</span>
                </div>
                <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-[#1A1A1A] flex items-center justify-center hover:bg-[#333] transition-colors">
                    <i data-lucide="x" class="w-4 h-4 text-white"></i>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="flex-1 overflow-y-auto p-6 text-sm text-[#DDD] leading-relaxed" id="modalBody">
                <!-- Content injected here -->
            </div>

            <!-- Modal Footer -->
            <div class="h-14 border-t border-[#222] flex items-center px-6 justify-end bg-[#0A0A0A] rounded-b-2xl">
                <span id="modalDate" class="text-[10px] text-[#444] font-mono">12:00 PM</span>
            </div>
        </div>
    </div>

    <!-- AI CHAT WIDGET -->
    <div class="fixed bottom-6 right-6 z-[200] flex flex-col items-end gap-4">
        
        <!-- Chat Box -->
        <div id="aiChatBox" class="w-80 h-[400px] glass-panel rounded-2xl flex flex-col shadow-2xl origin-bottom-right transition-all duration-300 transform scale-0 opacity-0 overflow-hidden">
            <!-- Header -->
            <div class="h-12 border-b border-[#222] bg-[#0A0A0A] flex items-center justify-between px-4">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-purple-500 animate-pulse"></div>
                    <span class="text-xs font-bold tracking-wider">KagentaBot</span>
                </div>
                <button onclick="toggleChat()" class="text-[#666] hover:text-white">
                    <i data-lucide="minus" class="w-4 h-4"></i>
                </button>
            </div>
            
            <!-- Messages -->
            <div id="aiMessages" class="flex-1 overflow-y-auto p-4 space-y-3 text-xs">
                <div class="bg-[#1F1F1F] text-[#DDD] p-3 rounded-lg rounded-tl-none self-start max-w-[85%]">
                    Hello! I am your personal concierge. Ask me anything about KagentaMail.
                </div>
            </div>

            <!-- Input -->
            <div class="p-3 bg-[#0A0A0A] border-t border-[#222] flex gap-2">
                <input type="text" id="aiInput" placeholder="Ask AI..." 
                    class="flex-1 bg-[#151515] border border-[#222] rounded-lg px-3 py-2 text-xs text-white outline-none focus:border-[#444]"
                    onkeypress="if(event.key === 'Enter') sendAiMessage()">
                <button onclick="sendAiMessage()" class="w-8 h-8 bg-white rounded-lg flex items-center justify-center hover:bg-gray-200 text-black">
                    <i data-lucide="send" class="w-4 h-4"></i>
                </button>
            </div>
        </div>

        <!-- Toggle Button -->
        <button onclick="toggleChat()" class="w-14 h-14 bg-white rounded-full shadow-[0_0_20px_-5px_rgba(255,255,255,0.3)] flex items-center justify-center hover:scale-105 transition-transform text-black z-[201]">
            <i data-lucide="sparkles" class="w-6 h-6"></i>
        </button>
    </div>

    <script>
        lucide.createIcons();

        let currentEmail = localStorage.getItem('kg_email') || '';
        let refreshInterval;
        let countdown = 5;

        // --- AI LOGIC ---
        function toggleChat() {
            const box = document.getElementById('aiChatBox');
            if (box.classList.contains('scale-0')) {
                box.classList.remove('scale-0', 'opacity-0');
            } else {
                box.classList.add('scale-0', 'opacity-0');
            }
        }

        async function sendAiMessage() {
            const input = document.getElementById('aiInput');
            const msg = input.value.trim();
            if (!msg) return;

            addAiBubble(msg, true);
            input.value = '';

            const id = addAiBubble("Thinking...", false, true);

            try {
                let model = "gpt5";
                if (msg.toLowerCase().includes("search") || msg.toLowerCase().includes("find")) model = "perplexity";
                
                const res = await fetch(`/ai/chat?message=${encodeURIComponent(msg)}&model=${model}&context=${encodeURIComponent(currentEmail)}`);
                const json = await res.json();
                
                const responseText = json.result || json.data || json.message || "I am unable to answer that right now.";
                document.getElementById(id).innerText = responseText;
                document.getElementById(id).classList.remove('animate-pulse', 'italic', 'text-[#666]');
            } catch (e) {
                document.getElementById(id).innerText = "Connection error.";
            }
        }

        function addAiBubble(text, isUser, isLoading = false) {
            const container = document.getElementById('aiMessages');
            const div = document.createElement('div');
            const id = 'msg-' + Date.now();
            div.id = id;
            
            div.className = isUser 
                ? "bg-white text-black p-3 rounded-lg rounded-tr-none self-end max-w-[85%] ml-auto"
                : "bg-[#1F1F1F] text-[#DDD] p-3 rounded-lg rounded-tl-none self-start max-w-[85%]";
            
            if (isLoading) div.classList.add('animate-pulse', 'italic', 'text-[#666]');
            
            div.innerText = text;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return id;
        }

        // --- CORE FUNCTIONS ---

        async function generateEmail() {
            const display = document.getElementById('emailDisplay');
            display.value = "Generating...";
            display.classList.add('animate-pulse');
            
            try {
                const res = await fetch('/api/create?version=v2');
                const data = await res.json();
                
                // FIXED: Support result.email structure
                const email = data.result?.email || data.email;
                
                if (email) {
                    currentEmail = email;
                    localStorage.setItem('kg_email', currentEmail);
                    display.value = currentEmail;
                    renderInbox([]); 
                    refreshInbox();
                } else {
                    display.value = "Error generating.";
                }
            } catch (e) {
                display.value = "Network Error";
            } finally {
                display.classList.remove('animate-pulse');
            }
        }

        async function refreshInbox() {
            if (!currentEmail) return;
            
            const btn = document.querySelector('button[onclick="refreshInbox()"] i');
            if(btn) btn.classList.add('animate-spin');

            try {
                const res = await fetch(`/api/inbox?email=${currentEmail}&version=v2`);
                const data = await res.json();
                renderInbox(data);
            } catch (e) {
                console.error("Inbox error", e);
            } finally {
                if(btn) setTimeout(() => btn.classList.remove('animate-spin'), 500);
            }
        }

        function renderInbox(data) {
            const list = document.getElementById('inboxList');
            const count = document.getElementById('msgCount');
            
            // FIXED: Handle result array
            const mails = Array.isArray(data.result) ? data.result : (Array.isArray(data) ? data : []);
            count.innerText = mails.length;

            if (mails.length === 0) {
                list.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center text-[#222]">
                        <i data-lucide="ghost" class="w-16 h-16 mb-4 opacity-50"></i>
                        <p class="text-sm">Inbox Empty</p>
                    </div>`;
                lucide.createIcons();
                return;
            }

            let html = "";
            mails.forEach((msg, idx) => {
                html += `
                    <div onclick="openModal(${idx})" class="group cursor-pointer p-4 rounded-xl border border-transparent hover:bg-[#0F0F0F] hover:border-[#222] transition-all duration-200 animate-in fade-in slide-in-from-bottom-2">
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-semibold text-sm text-white group-hover:text-blue-400 transition-colors">${msg.subject || '(No Subject)'}</span>
                            <span class="text-[10px] text-[#444] font-mono">${msg.date || 'Now'}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-[#666] truncate max-w-[200px]">${msg.from}</span>
                            <i data-lucide="chevron-right" class="w-3 h-3 text-[#333] group-hover:text-white transition-colors"></i>
                        </div>
                    </div>
                `;
            });
            
            list.innerHTML = html;
            lucide.createIcons();
            window.currentMessages = mails;
        }

        // --- UTILS ---

        function copyEmail() {
            const email = document.getElementById('emailDisplay').value;
            if (!email || email.includes('...')) return;
            
            navigator.clipboard.writeText(email);
            const feedback = document.getElementById('copyFeedback');
            feedback.style.opacity = '1';
            setTimeout(() => feedback.style.opacity = '0', 1500);
        }

        function openModal(idx) {
            const msg = window.currentMessages[idx];
            document.getElementById('modalSubject').innerText = msg.subject || '(No Subject)';
            document.getElementById('modalFrom').innerText = msg.from;
            document.getElementById('modalDate').innerText = msg.date || '';
            
            const bodyDiv = document.getElementById('modalBody');
            if (msg.html) {
                bodyDiv.innerHTML = msg.html;
            } else {
                bodyDiv.innerText = msg.text || '(No Content)';
            }

            const modal = document.getElementById('mailModal');
            const content = document.getElementById('modalContent');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95');
                content.classList.add('scale-100');
            }, 10);
        }

        function closeModal() {
            const modal = document.getElementById('mailModal');
            const content = document.getElementById('modalContent');
            modal.classList.add('opacity-0');
            content.classList.remove('scale-100');
            content.classList.add('scale-95');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

        function startTimer() {
            const el = document.getElementById('timer');
            setInterval(() => {
                countdown--;
                if (countdown <= 0) {
                    refreshInbox();
                    countdown = 5;
                }
                if(el) el.innerText = countdown;
            }, 1000);
        }

        window.onload = () => {
            if (currentEmail) {
                document.getElementById('emailDisplay').value = currentEmail;
                refreshInbox();
            } else {
                generateEmail();
            }
            startTimer();
        };
    </script>
</body>
</html>